# DO NOT MAKE CHANGES TO THIS FILE.  Instead, modify
# ci/settings.yml and override what needs overridden.
# This uses spruce, so you have some options there.
---
meta:
  name:     (( param "Library name" ))
  pipeline: (( grab meta.name ))
  target:   "am"

  git:
    email:  "<>"
    name:   "CI Bot"

  go:
    module: (( concat "github.com/" meta.github.owner "/" meta.github.repo ))

  vendor:
    image: am-registry:5000/anothermemory/go-vendor
    tag:
      develop:  "develop"
      master:   "master"

  github:
    uri:          (( concat "git@github.com:" meta.github.owner "/" meta.github.repo ))
    owner:        "anothermemory"
    repo:         (( param "Please specify the name of the Github repository" ))
    private_key:  ((git_private_key))
    access_token: ((git_access_token))

  docker:
      registry: am-registry:5000
      image_prefix: (( concat meta.docker.registry "/anothermemory/" ))

  resource:
    git:
      type: git
      check_every: 15s
      source:
        uri: (( grab meta.github.uri ))
        private_key: (( grab meta.github.private_key ))
        branch: master
    dockerimage:
      base:
        type: docker-image
        check_every: 15s
        source:
          tag: master
          insecure_registries: [ (( grab meta.docker.registry )) ]
      go-vendor:
        .: (( inject meta.resource.dockerimage.base ))
        source: { repository: (( concat meta.docker.image_prefix "go-vendor" )) }

  task:
    master:
      image: docker-image-go-vendor-master
      input_mapping: {code: git-master}
      params:
        MODULE: (( grab meta.go.module ))
    develop:
      image: docker-image-go-vendor-develop
      input_mapping: {code: git-develop}
      params:
        MODULE: (( grab meta.go.module ))


resources:
- name: git-develop
  .: (( inject meta.resource.git ))
  source: { branch: develop}

- name: git-master
  .: (( inject meta.resource.git ))

- name: docker-image-go-vendor-develop
  .: (( inject meta.resource.dockerimage.go-vendor ))
  source: { tag: develop}

- name: docker-image-go-vendor-master
  .: (( inject meta.resource.dockerimage.go-vendor ))

jobs:
- name: "test-develop"
  serial: true
  plan:
  - aggregate:
    - { get: docker-image-go-vendor-develop, trigger: true }
    - { get: git-develop, trigger: true }
  - task: get-version
    .: (( inject meta.task.develop ))
    file: git-develop/ci/tasks/get-version.yml
  - aggregate:
    - task: build
      .: (( inject meta.task.develop ))
      file: git-develop/ci/tasks/build.yml
    - task: lint
      .: (( inject meta.task.develop ))
      file: git-develop/ci/tasks/lint.yml
    - task: test
      .: (( inject meta.task.develop ))
      file: git-develop/ci/tasks/test.yml

- name: "test-master"
  serial: true
  plan:
  - aggregate:
    - { get: docker-image-go-vendor-master, trigger: true }
    - { get: git-master, trigger: true }
  - task: get-version
    .: (( inject meta.task.master ))
    file: git-develop/ci/tasks/get-version.yml
  - aggregate:
    - task: build
      .: (( inject meta.task.master ))
      file: git-master/ci/tasks/build.yml
    - task: lint
      .: (( inject meta.task.master ))
      file: git-master/ci/tasks/lint.yml
    - task: test
      .: (( inject meta.task.master ))
      file: git-master/ci/tasks/test.yml